<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>BlockMirror</title>

    <!-- Pyodide -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.22.1/full/pyodide.js"></script>

    <!-- Blockly  -->
    <script src="../lib/blockly/blockly_compressed.js" type="text/javascript"></script>
    <script src="../lib/blockly/blocks_compressed.js" type="text/javascript"></script>
    <script src="../lib/blockly/msg/js/zh-hant.js" type="text/javascript"></script>
    <script src="../lib/blockly/python_compressed.js" type="text/javascript"></script>

    <!-- CodeMirror -->
    <link rel="stylesheet" href="../lib/codemirror/codemirror.css">
    <link rel="stylesheet" href="../lib/codemirror/fullscreen.css">
    <link rel="stylesheet" href="../lib/codemirror/show-hint.css">
    <script src="../lib/codemirror/codemirror.js" type="text/javascript"></script>
    <script src="../lib/codemirror/show-hint.js" type="text/javascript"></script>
    <script src="../lib/codemirror/python-hint.js" type="text/javascript"></script>
    <script src="../lib/codemirror/fullscreen.js" type="text/javascript"></script>
    <script src="../lib/codemirror/python.js" type="text/javascript"></script>

    <!-- Skulpt -->
    <script src="../dist/skulpt_parser.js" type="text/javascript"></script>

    <!-- BlockMirror -->
    <link rel="stylesheet" href="../dist/block_mirror.css">
    <script src="../dist/block_mirror.js" type="text/javascript"></script>
    <link rel="stylesheet" href="./style.css">

</head>

<body>
    <div id='menubar' class="btn-group" data-toggle="buttons" data-bind="visible: !assignment.upload()">
        <div style="padding-top: 10px;">
            <label onclick="editor.setMode('block');">
                <input type="radio" name="blockpy-mode-set" autocomplete="off"> Blocks
            </label>
            <label onclick="editor.setMode('split');">
                <input type="radio" name="blockpy-mode-set" autocomplete="off" checked> Split
            </label>
            <label onclick="editor.setMode('text');">
                <input type="radio" name="blockpy-mode-set" autocomplete="off"> Text
            </label>
            <button id='run' disabled="enable">Run</button>
        </div>
    </div>
    <div id='code-frame'>
        <div id="blockmirror-editor"></div>
    </div>
    <div id="output-frame">
        <div id='output-title'>Python 終端輸出</div>
        <div id="output"></div>
        <br>
        <button id="help">小助手</button>
    </div>
    <div id="myModal" class="modal">
        <div class="modal-content">
            您好，我是 Python 小助手，可以問我程式問題呦
            <textarea></textarea>
            <input type='button' style='float:right' value='送出'>
            <textarea></textarea>
            <button id="closeBtn" class='close-btn'>關閉</button>
        </div>
    </div>

    <script type="text/javascript">
        let run = document.getElementById('run');
        let output = document.getElementById('output');
        let menubar = document.getElementById('menubar');
        var editor = new BlockMirror({
            'container': document.getElementById('blockmirror-editor'),
            'height': window.innerHeight - menubar.scrollHeight /*toolbar height*/,
            // empty, minimal , ct , normal , full
            'toolbox': 'wa',
        });
        editor.addChangeListener(function (event) {
            console.log('Change! Better save:', event)
        });
        /*
        editor.textEditor.codeMirror.on('keypress', (instance) => {
            instance.showHint();
        });
        */
        editor.setCode('print("Hello World!")');
        run.addEventListener('click', async function () {
            output.innerHTML = '';
            await runPython(editor.getCode());
        });
        //// editor autocomplete
        const ignore = ['', '#', '!', '-', '=', '@', '$', '%', '&', '+', ';', '(', ')', '*'];
        const ignoreToken = (text) => {
            if (text && text[0]) {
                for (const pre in ignore) {
                    if (ignore[pre] === text[0]) {
                        return true;
                    }
                }
            } else {
                return true;
            }
            return false;
        };

        editor.textEditor.codeMirror.on("change", function (editor, change) {
            if (change.origin == "+input") {
                var text = change.text;
                if (!ignoreToken(text))
                    setTimeout(function () { editor.execCommand("autocomplete"); }, 500);
            }
        });


    </script>
    <script>
        // 获取按钮和弹出窗口
        var btn = document.getElementById("help");
        var modal = document.getElementById("myModal");
        var closeBtn = document.getElementById("closeBtn");

        // 点击按钮弹出窗口
        btn.onclick = function () {
            modal.style.display = "block";
        }

        // 点击关闭按钮关闭窗口
        closeBtn.onclick = function () {
            modal.style.display = "none";
        }

        // 点击遮罩层关闭窗口
        window.onclick = function (event) {
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }
    </script>

    <script async src="../lib/pyodide/lib_pyodide.js"></script>
</body>

</html>