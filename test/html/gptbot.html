<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.1.0/paho-mqtt.min.js"></script>
    <script src="../js/mqttapp.js"></script>
    <style>
        body {
            margin: 0px;
        }

        .txt-content {
            width: calc(100% - 9px);
            height: calc(100vh - 64px);
            font-size: 1.2em;
            margin: 3px;
        }

        .send {
            margin: 6px;
            width: 50px;
            height: 32px;
        }
    </style>
</head>

<body>
    <button class='send' onclick="send()">Send</button>
    <div class="txt-content">
        <textarea id="show" class='txt-content' id="messageInput" cols="50"></textarea>
    </div>

    <script>
        var isCode = false;
        var genCode = '';

        function fixCode(code) {
            const hasWbitPub = code.includes('wbit.pub');
            const hasWbitSub = code.includes('wbit.sub');
            const hasWbitCheckMsg = code.includes('wbit.checkMsg');
            const hasWbitWriteSheet = code.includes('wbit.writeSheet');
            const hasWbitFunctions = hasWbitPub || hasWbitSub || hasWbitWriteSheet || hasWbitCheckMsg;
            if (hasWbitFunctions) {
                code = code.replaceAll('wbit = WebBit()', 'wbit = WebBit()\nwbit.connect()')
            }
            return code;
        }

        function send() {
            app.publish(topic, show.value);
        }
        function appendToShow(str, isEnd) {
            console.log("isEnd:", isEnd);
            var cnt = show.value;
            cnt = cnt + str + "\n";
            show.value = cnt;
            try {
                setCode(str);
            } catch (e) { }
            if (isEnd) {
                var code = parent.editor.getCode();
                code = fixCode(code);
                parent.editor.setCode(code);
            }
        }
        function setCode(code) {
            if (code.indexOf('```') == 0 && isCode) {
                isCode = false;
                genCode = '';
                return;
            }
            if (code.indexOf('```') == 0) {
                isCode = true;
                return;
            }
            if (!isCode) return;
            genCode = genCode + code + '\n';
            parent.editor.setCode(genCode); // 輸出提取結果
        }
        //var topic = 'gptbot/python';
        var topic = 'gptbot/wbit';
        const app = new MQTTApp();
        (async function () {
            await app.init(topic, appendToShow);
        })();
    </script>
</body>

</html>