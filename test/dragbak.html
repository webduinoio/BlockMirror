<!DOCTYPE html>
<html>

<head>
    <title>Draggable Divs</title>
    <style>
        .box {
            position: relative;
            width: 200px;
            height: 200px;
            background-color: #f0f0f0;
        }

        .title {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #ccc;
            cursor: move;
            display: none;
            z-index: 2;
            opacity: 0.5;
        }

        #startButton,
        #stopButton {
            margin-top: 20px;
            padding: 10px;
            font-size: 16px;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <button id="startButton">Start</button>
    <button id="stopButton">Stop</button>
    <div>
        <div id="box1" class="box">
            <h1>哈哈</h1>
        </div>
        <div id="box2" class="box">
            <h1>OKOK</h1>
        </div>
    </div>
    <script>
        /*
        畫面絕對座標
            evt.srcElement.getBoundingClientRect()['x']


        */
        class Box {

            static boxes = [];

            static addBox(box) {
                Box.boxes.push(box);
            }

            static getBoxes() {
                return Box.boxes;
            }

            constructor(boxId) {
                this.swapPos = false;
                this.mPos = { "x": 0, "y": 0 };
                this.isDragging = false;
                this.isStarted = false;
                this.eleTitle = document.createElement('div');
                this.eleTitle.classList.add("title");
                this.eleBox = document.getElementById(boxId);
                this.eleBox.appendChild(this.eleTitle);
                this.container = document.getElementsByTagName('body')[0];
                this.x = 0;
                this.y = 0;
                window[this.eleBox.id] = this.eleBox;
                this.info();
            }

            info(evt) {
                var x = this.eleBox.getBoundingClientRect()['x'];
                var y = this.eleBox.getBoundingClientRect()['y'];
                console.log(this.eleBox.id, "x:", x, ",y:", y,
                    "ox:", this.eleBox.offsetLeft,
                    "oy:", this.eleBox.offsetTop);
                if (evt) {
                    console.log("ex:", evt.clientX, ",ey:", evt.clientY);
                }
            }

            checkSwapPos(self) {
                var boxList = Box.getBoxes();
                for (var i in boxList) {
                    if (boxList[i].swapPos) {
                        var x = boxList[i].eleBox.offsetLeft;
                        var y = boxList[i].eleBox.offsetTop;
                        boxList[i].eleBox.style.left = self.originX + "px";
                        boxList[i].eleBox.style.top = self.originY + "px";
                        self.eleBox.style.left = x + "px";
                        self.eleBox.style.top = y + "px";
                        console.log("Swap..", self.eleBox.id, boxList[i].eleBox.id);
                        console.log(boxList[i].eleBox.id, boxList[i].eleBox.style.left, boxList[i].eleBox.style.top);
                        boxList[i].eleBox.swapPos = false;
                        break;
                    }
                }
            }

            checkNearestBox(self, distance) {
                var boxList = Box.getBoxes();
                for (var i in boxList) {
                    var aBox = boxList[i];
                    if (aBox.eleBox == self.eleBox) {
                        continue;
                    }
                    var x1 = self.eleBox.offsetLeft;
                    var y1 = self.eleBox.offsetTop;
                    var x2 = aBox.eleBox.offsetLeft;
                    var y2 = aBox.eleBox.offsetTop;
                    var calDistance = Math.sqrt((x2 - x1) * (x2 - x1) + (y2 - y1) * (y2 - y1));
                    if (calDistance <= distance) {
                        aBox.eleTitle.style['border'] = '1px solid #f47';
                        aBox.swapPos = true;
                    } else {
                        aBox.swapPos = false;
                        aBox.eleTitle.style['border'] = '0px';
                    }
                }
            }

            startDrag() {
                var self = this;
                this.isStarted = true;
                // Show the titlebars
                this.getTitle().style.display = "block";
                // Add event listeners to the titlebars
                this.startDragEvent = function (evt) {
                    if (evt.srcElement != self.eleTitle) {
                        return;
                    }
                    self.info(evt);
                    evt.preventDefault();
                    self.isDragging = true;
                    self.mPos.x = self.originX = evt.clientX;
                    self.mPos.y = self.originY = evt.clientY;
                    //self.originX = evt.srcElement.getBoundingClientRect()['x'];
                    //self.originY = evt.srcElement.getBoundingClientRect()['y'];
                };
                this.dragingEvent = function (evt) {
                    if (self.isDragging) {
                        // Calculate the new position of the box
                        var dx = evt.clientX - self.mPos.x;
                        var dy = evt.clientY - self.mPos.y;
                        self.x += dx;
                        self.y += dy;
                        // Update the position of the box
                        self.getBox().style.top = self.y + "px";
                        self.getBox().style.left = self.x + "px";
                        self.mPos.x = evt.clientX;
                        self.mPos.y = evt.clientY;
                        self.checkNearestBox(self, 200);
                    }
                }
                this.stopDragEvent = function (evt) {
                    evt.preventDefault();
                    if (self.isDragging) {
                        console.log("origin:", self.originX, self.originY);
                        self.checkSwapPos(self);
                    }
                    self.isDragging = false;
                };
                this.getTitle().addEventListener("mousedown", this.startDragEvent);
                self.container.addEventListener("mousemove", this.dragingEvent);
                self.container.addEventListener("mouseup", this.stopDragEvent);
            }

            stopDrag() {
                var self = this;
                this.isStarted = false;
                this.getTitle().style.display = "none";
                this.getTitle().removeEventListener("mousedown", this.startDragEvent);
                self.container.removeEventListener("mousemove", this.dragingEvent);
                self.container.removeEventListener("mouseup", this.stopDragEvent);
            }

            getTitle() {
                return this.eleTitle;
            }
            getBox() {
                return this.eleBox;
            }
        }

        Box.addBox(new Box('box1'));
        Box.addBox(new Box('box2'));
        var boxes = Box.getBoxes();

        var startButton = document.getElementById("startButton");
        startButton.addEventListener("click", function () {
            for (var i in boxes) {
                Box.boxes[i].startDrag();
            }
        });
        var stopButton = document.getElementById("stopButton");
        stopButton.addEventListener("click", function () {
            for (var i in boxes) {
                boxes[i].stopDrag();
            }
        });
    </script>


</body>

</html>