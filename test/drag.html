<!DOCTYPE html>
<html>

<head>
    <title>Draggable Divs</title>
    <style>
        .box {
            position: relative;
            width: 200px;
            height: 200px;
            background-color: #f0f0f0;
        }

        .title {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #ccc;
            cursor: move;
            display: none;
            z-index: 2;
            opacity: 0.5;
        }

        #startButton,
        #stopButton {
            margin-top: 20px;
            padding: 10px;
            font-size: 16px;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <button id="startButton">Start</button>
    <button id="stopButton">Stop</button>
    <div>
        <div id="box1" class="box">
            <h1><span style='font-size:164px'>1</span></h1>
        </div>
        <div id="box2" class="box">
            <h1><span style='font-size:164px'>2</span></h1>
        </div>
        <div id="box3" class="box">
            <h1><span style='font-size:164px'>3</span></h1>
        </div>
    </div>
    <script>
        class Box {

            static boxes = [];

            static addBox(box) {
                Box.boxes.push(box);
            }

            static getBoxes() {
                return Box.boxes;
            }

            constructor(boxId) {
                this.swapPos = false;
                this.isDragging = false;
                this.isStarted = false;
                this.eleTitle = document.createElement('div');
                this.eleTitle.classList.add("title");
                this.eleBox = document.getElementById(boxId);
                this.eleBox.appendChild(this.eleTitle);
                this.container = document.getElementsByTagName('body')[0];
                window[this.eleBox.id] = this.eleBox;
                // element's origin x,y (eg. client.x , client.y)
                this.x = 0;
                this.y = 0;
                this.mPos = { "x": 0, "y": 0 };
                this.originX = this.eleBox.offsetLeft;
                this.originY = this.eleBox.offsetTop;
                this.info();
            }

            info(evt) {
                console.log(this.eleBox.id,
                    "ox:", this.originX, "oy:", this.originY);
            }

            checkSwapPos(self) {
                var boxList = Box.getBoxes();
                for (var i in boxList) {
                    if (boxList[i].swapPos) {
                        boxList[i].swapPos = false;
                        var dx = self.originX - boxList[i].originX;
                        var dy = self.originY - boxList[i].originY;
                        self.eleBox.style.left = -1 * dx + "px";
                        self.eleBox.style.top = -1 * dy + "px";
                        self.originLeft = -1 * dx + "px";
                        self.originTop = -1 * dy + "px";
                        self.originX = -1 * dx;
                        self.originY = -1 * dy;
                        boxList[i].eleBox.style.left = 1 * dx + "px";
                        boxList[i].eleBox.style.top = 1 * dy + "px";
                        boxList[i].originLeft = 1 * dx + "px";
                        boxList[i].originTop = 1 * dy + "px";
                        boxList[i].originX = 1 * dx;
                        boxList[i].originY = 1 * dy;
                        boxList[i].eleTitle.style['border'] = '0px';
                        console.log("Swap..",
                            self.originX, self.originY,
                            boxList[i].originX, boxList[i].originY);
                        break;
                    }
                }
            }

            hasSwapBox() {
                var boxList = Box.getBoxes();
                for (var i in boxList) {
                    if (boxList[i].swapPos) {
                        return true;
                    }
                }
                return false;
            }

            checkNearestBox(self, distance) {
                var boxList = Box.getBoxes();
                for (var i in boxList) {
                    var aBox = boxList[i];
                    if (aBox.eleBox == self.eleBox) {
                        continue;
                    }
                    var x1 = self.eleBox.offsetLeft;
                    var y1 = self.eleBox.offsetTop;
                    var x2 = aBox.eleBox.offsetLeft;
                    var y2 = aBox.eleBox.offsetTop;
                    var calDistance = Math.sqrt((x2 - x1) * (x2 - x1) + (y2 - y1) * (y2 - y1));
                    if (calDistance <= distance) {
                        aBox.eleTitle.style['border'] = '1px solid #f47';
                        aBox.swapPos = true;
                    } else {
                        aBox.eleTitle.style['border'] = '0px';
                        aBox.swapPos = false;
                    }
                }
            }

            startDrag() {
                var self = this;
                this.isStarted = true;
                // Show the titlebars
                this.getTitle().style.display = "block";
                // Add event listeners to the titlebars
                this.startDragEvent = function (evt) {
                    if (evt.srcElement != self.eleTitle) {
                        return;
                    }
                    self.info(evt);
                    evt.preventDefault();
                    self.originLeft = self.getBox().style.left;
                    self.originTop = self.getBox().style.top;
                    self.isDragging = true;
                    self.mPos.x = evt.clientX;
                    self.mPos.y = evt.clientY;
                    self.x = self.originX;
                    self.y = self.originY;
                };
                this.dragingEvent = function (evt) {
                    if (self.isDragging) {
                        // Calculate the new position of the box
                        var dx = evt.clientX - self.mPos.x;
                        var dy = evt.clientY - self.mPos.y;
                        self.x += dx;
                        self.y += dy;
                        // Update the position of the box
                        self.getBox().style.top = self.y + "px";
                        self.getBox().style.left = self.x + "px";
                        self.mPos.x = evt.clientX;
                        self.mPos.y = evt.clientY;
                        self.checkNearestBox(self, 100);
                    }
                }
                this.stopDragEvent = function (evt) {
                    evt.preventDefault();
                    if (self.isDragging) {
                        self.info(evt);
                        if (!self.hasSwapBox()) {
                            console.log("no swap,restore");
                            self.getBox().style.left = self.originLeft;
                            self.getBox().style.top = self.originTop;
                            self.mPos = { "x": 0, "y": 0 };
                            self.x = self.y = 0;
                        } else {
                            self.checkSwapPos(self);
                        }
                    }
                    self.isDragging = false;
                };
                this.getTitle().addEventListener("mousedown", this.startDragEvent);
                self.container.addEventListener("mousemove", this.dragingEvent);
                self.container.addEventListener("mouseup", this.stopDragEvent);
            }

            stopDrag() {
                var self = this;
                this.isStarted = false;
                this.getTitle().style.display = "none";
                var boxList = Box.getBoxes();
                this.getTitle().removeEventListener("mousedown", this.startDragEvent);
                self.container.removeEventListener("mousemove", this.dragingEvent);
                self.container.removeEventListener("mouseup", this.stopDragEvent);
            }

            getTitle() {
                return this.eleTitle;
            }
            getBox() {
                return this.eleBox;
            }
        }

        Box.addBox(new Box('box1'));
        Box.addBox(new Box('box2'));
        Box.addBox(new Box('box3'));
        var boxes = Box.getBoxes();

        var startButton = document.getElementById("startButton");
        startButton.addEventListener("click", function () {
            for (var i in boxes) {
                Box.boxes[i].startDrag();
            }
        });
        var stopButton = document.getElementById("stopButton");
        stopButton.addEventListener("click", function () {
            for (var i in boxes) {
                boxes[i].stopDrag();
            }
        });

        for (var i in boxes) {
            Box.boxes[i].startDrag();
        }
    </script>


</body>

</html>